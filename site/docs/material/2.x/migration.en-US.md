`````
Material Market 2.0

# Migration

How to migrate existing materials from 1.x to 2.x

`````
*Auto translate by google.*

When reading this document, we assume that you already know the background and changes of 2.x materials. If you don't know, please read the first chapter of this manual.
We provide an NPM package named @arco-cli/migration-helper to assist in migration. The migration tool cannot complete the entire migration process, but it completes a lot of repetitive replacement work (mainly the organization of component demos) to save you time.

**ðŸ’¡ Before starting the migration, please make sure to commit all uncommitted contents in your Git workspace before continuing. The "Project Changes" section mainly explains the project content changed during the migration process. ++Please do not change it manually immediately++, the migration tool will automatically help you complete most of the content inside. **
## Project changes
#### Need to be removed
###### Storybook related
1.0 materials use Storybook for local development, and 2.0 will use built-in development tools. Therefore, the Storybook configuration and Stories files in the project can be removed:
![Image](https://p9-arcosite.byteimg.com/tos-cn-i-goo7wpa0wc/957fab581cc141e5a8295a4f39d8d42b~tplv-goo7wpa0wc-image.image)
###### 1.0 configuration file
arco-cli 2.0 is completely rewritten, and the configuration file corresponding to 1.0 will no longer be effective and can be removed from the project. They include:

* Configuration files for arco-cli and arco-scripts in the root directory:

![Image](https://p9-arcosite.byteimg.com/tos-cn-i-goo7wpa0wc/6a79c63c3d5c4c6ebd211ed4a8bb7b16~tplv-goo7wpa0wc-image.image)

* Configuration files for arco-scripts in the material NPM package:

![Image](https://p9-arcosite.byteimg.com/tos-cn-i-goo7wpa0wc/76432229fad34fe98f89b38ddafacc05~tplv-goo7wpa0wc-image.image)

* For component API in the component directory Template files automatically generated by the document:

![Image](https://p9-arcosite.byteimg.com/tos-cn-i-goo7wpa0wc/1a0c5b89b5a545d6a9eb87eca56373fc~tplv-goo7wpa0wc-image.image)

* Material metadata description file arcoMeta.json;

###### Team site
If your material project does not use the "Team Site" function, you can skip this section.
We recommend that you maintain all your materials and documents on the material team page. If you have used the team site function before, you can remove it from the project.
#### Need to be adjusted
###### Demo document
2.0 has adjusted the organization of material documents and will use MDX to write. Therefore, the writing format of the material document needs to be adjusted:
```JavaScript
/**
* @file
* @name AnimateWall
* @memberOf Information display
* @description Alternate fading animation wall, based on [gsap](https://github.com/greensock/GSAP) package
* @author yuhan0709
* @package @arco-materials/animate-wall
*/

/**
* @name Basic usage
* @description [`Arco official website`](https://arco.design/) example, alternate fading of icons.
*/
export { default as Basic } from './basic';

/**
* @name Custom element
* @description Alternate fading of custom elements.
*/
export { default as Custom } from './custom';
```

The old Demo document entry written in JS file needs to be adjusted to MDX format:
```Markdown
---
title: AnimateWall
description: Alternating and fading animation wall, based on [gsap](https://github.com/greensock/GSAP) package
labels: ['Information display']
---

## Basic usage

[`Arco official website`](https://arco.design/) example, icons are alternately displayed.

import Basic from './basic';

<div data-arco-demo="Basic">
<Basic />
</div>

## Custom elements

import Custom from './custom';

<div data-arco-demo="Custom">
<Custom/>
</div>

```

###### Unit test
We have removed the unit test's dependency on [Enzyme ](https://www.npmjs.com/package/enzyme) and only built-in Jest dependency. After upgrading to arco-cli 2.0, the old single test logic needs to be adjusted. It is recommended to cooperate with [@testing-library/react](https://www.npmjs.com/package/@testing-library/react) to write test cases.
###### Material package.json

* Need to be removed:
* All scripts in the scripts field that depend on arco / arco-scripts commands;

![Image](https://p9-arcosite.byteimg.com/tos-cn-i-goo7wpa0wc/09e09fbb1b254c0b9571e724d50dd0b0~tplv-goo7wpa0wc-image.image)

* umd field (2.0 does not support building material UMD products);

![Image](https://p9-arcosite.byteimg.com/tos-cn-i-goo7wpa0wc/83204328c955420c8185a8c350546e8f~tplv-goo7wpa0wc-image.image)

* arcoMeta Fields:

![Image](https://p9-arcosite.byteimg.com/tos-cn-i-goo7wpa0wc/4e252097d2c04252b3d0a1e7c525851b~tplv-goo7wpa0wc-image.image)

* Dependencies / devDependencies related to Storybook / arco-cli / arco-scripts:

![Image](https://p9-arcosite.byteimg.com/tos-cn-i-goo7wpa0wc/767cb51136a44745b01fb0add0bf2d7e~tplv-goo7wpa0wc-image.image)

* Root directory package.json needs to add:
* Add a dependency on @arco-cli/arco in devDependencies;
* Add arco-cli related commands in scripts;

![Image](https://p9-arcosite.byteimg.com/tos-cn-i-goo7wpa0wc/68f251f6c0ac48c3915cbc390c336029~tplv-goo7wpa0wc-image.image)
#### Need to be added

* Workspace configuration file arco.workspace.jsonc;

* Workspace component environment configuration file arco.env.js;

## Migration tool
#### Start migration
We recommend that you perform an automatic migration test on a component first. **Remind again, please save your Git workspace commit before migration. **
```Bash
## Execute the migration tool with the following command
## --include accepts a glob pattern for specifying a component directory
npx @arco-cli/migration-helper migrate --include="packages/arco-site-anchor/src"
```

Note: The parameter specified by `--include` needs to be the entry of the component directory, not the NPM package directory. For example, for a multi-package project it should be `packages/*/src`, and for a single-package multi-component project it should be `components/*`.
![](https://p9-arcosite.byteimg.com/tos-cn-i-goo7wpa0wc/da371f208c1448a3a43c5ce43fbd66c6~tplv-goo7wpa0wc-image.image)

The migration command will automatically complete most of the migration work mentioned above, including:

* Add workspace configuration and remove unnecessary project files;

* Adjust component directories, including component demo directories and unit test directories;

* In multi-package projects, adjust the configuration of each sub-package;

#### Verification
After completing the migration of all components, please search the `TODO: AUTO MIGRATION CHECK` text globally. This contains the risk items that may be generated by automatic migration. Please check manually.
![å›¾ç‰‡](https://p9-arcosite.byteimg.com/tos-cn-i-goo7wpa0wc/e36d3e92bd6c493c90c60795add8902f~tplv-goo7wpa0wc-image.image)
After the migration is complete, please verify the following command:
```Bash
## Verify the local development preview of the component, and there are no abnormalities in the Demo and API documents
npx arco start

## Verify the component build process and check the component build product
npx arco build

## Verify the component unit test case, where you may need to manually adapt the unit test case
npx arco test
```

#### Possible problems
After the migration command is executed, reinstall the project dependencies and execute the `npm start` command to enter the development preview. You may encounter the following problems:
####### Webpack cannot parse the NPM module of the current component
If your Demo code is passed through NPM The package name introduces the current component. You need to configure the `resolve.alias` field for Webpack to map it to the source directory of this component. Please add the following configuration for the component preview Webpack in the root directory `arco.env.js`:

![](https://p9-arcosite.byteimg.com/tos-cn-i-goo7wpa0wc/05e0d0fd96904e1b8c5948cbfa1ed582~tplv-goo7wpa0wc-image.image)

You can also use a function like the following to automatically obtain the Alias â€‹â€‹configuration of all components in the workspace:
```JavaScript
const fs = require('fs-extra');
const path = require('path');
const glob = require('glob');

function tryCollectPackageWebpackAlias() {
const packages = glob.sync(path.resolve(__dirname, 'packages/*'));
const aliasRules = {};
for (const packageDir of packages) {
try { const packageJson = fs.readJsonSync(path.resolve(packageDir, 'package.json'));
const [packageSourceDir] = glob.sync(path.resolve(packageDir, '{src,components}'));
if (packageSourceDir) {
aliasRules[`${packageJson.name}$`] = packageSourceDir;
}
} catch (err) {
console.error(`arco.env.js [tryCollectPackageWebpackAlias]:\n${err.toString()}`);
}
}
return aliasRules;
}
```

###### Component preview lacks Arco basic styles
There are two ways to inject component styles:

* Manually in the component's document preview file `index.mdx` Import style files:

![Image](https://p9-arcosite.byteimg.com/tos-cn-i-goo7wpa0wc/71057873bdff45b5a79047ea948ea090~tplv-goo7wpa0wc-image.image)

* Add configuration to Webpack for component preview through the root directory `arco.env.js`, expand the MDX file content during compilation, and automatically inject the required style into the component:

![Image](https://p9-arcosite.byteimg.com/tos-cn-i-goo7wpa0wc/2d3187d7fc0c4ad8a7cf2d4b9e37112f~tplv-goo7wpa0wc-image.image)
###### Component preview lacks API documentation
2.0 Materials no longer require additional execution `arco docgen` command to generate API documentation. However, the scanning rules of API documents are consistent with 1.0. You need to specify the files to be scanned and follow specific TS definition writing rules:

* The default file entry for searching API documents is `interface.ts`. Modify the files to be parsed through the following fields in `arco.workspace.jsonc`:

``JSON
{
"arco.aspect/workspace": {
"components": {
// This part is the rules inherited by all components
"extends": {
"rootDir": "src",
"entries": {
"base": "./",
"main": "index.ts",
"style": "style/index.ts",
"preview": "__docs__/index.mdx",
// Define the document parsing entry common to all components
"jsdoc": [
"interface.ts"
]
}
},
"members": [
// This part is the specific rules for a single component
{
"rootDir": "packages/arco-site-anchor/src",
"name": "SiteAnchor",
"entries": {
// Define the document parsing entry for a component
"jsdoc": "index.tsx"
}
}
]
}
}
}
```

* Check if the component API TS definition complies with the following specifications:

**Only interface or type declarations with ** **`@title` will be extracted. **The following tags are available for property annotations:

* `@zh` Chinese description of the property
* `@en` English description of the property (optional)
* `@defaultValue` Default value of the property (optional)
* `@version` From which version the property was added (optional)

```TypeScript
/**
* @title Button (required, only interfaces or types with `title` description will be collected)
*/
interface ButtonProps {
/**
* @zh Button size (Chinese description of the property)
* @en Size of Button (optional, English description of the property)
* @version 1.2.0 (optional, which version the new property is supported in)
* @defaultValue 'default' (optional, default value of the property)
*/
size?: 'mini' | 'small' | 'default' | 'large';
}
```

###### Specify the team and author of the material
Please specify it in `arco.workspace.jsonc` Configure the team ID and author of the material in ```JSON
{
"arco.aspect/workspace": {
"components": {
// This part is the rules inherited by all components
"extends": {
"rootDir": "src",
// Specify the team ID to which the material belongs
"group": 1,
// Specify the author of the material, the prefix of the employee email address in the intranet
"author": "misterluffy"
},
"members": [
// This part is the specific rules for a single component
]
}
}
}
```

## Process changes
#### Build process
After migrating to 2.0, the build will automatically take effect for all components configured in `arco.workspace.jsonc`. Therefore, before releasing the version, please execute the full `npx arco build` to build all components;
#### Document synchronization
ðŸ’¡ **Before material synchronization, intranet users need to switch the synchronization address to the intranet through ** **`npx arco host arco.bytedance.net`. **
After 2.0, we will maintain the material preview document independently from NPM, which allows you to update the document directly without releasing a new NPM version. Update the material document by following the steps below:
```Bash
## After completing the document adjustment, rebuild the component preview document
## You can specify the component name to build a specific component arco build Button
arco build

## Synchronize the new component preview document to the material platform
## You can specify the component name to synchronize a specific component arco sync Button
arco sync
```
